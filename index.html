
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>An Imbalist</title>
  <meta name="author" content="Yunxing dai">

  
  <meta name="description" content="Even we can build bug-free application with Erlang, some times we
still need Error Handler mechanisms(like dealing with physical
issues). Erlang has &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://Imbalism.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="An Imbalist" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">An Imbalist</a></h1>
  
    <h2>Because life is Imbalanced</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:Imbalism.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about.html">About</a></li>  
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/05/erlang-otp-error-handler/">Erlang OTP &#8211; Error Handler</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-05T09:52:00-05:00" pubdate data-updated="true">Jan 5<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/01/05/erlang-otp-error-handler/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Even we can build bug-free application with Erlang, some times we
still need <code>Error Handler</code> mechanisms(like dealing with physical
issues).</p>

<p>Erlang has its own error handler module to trigger error recovery procedure:
<code>alarm_handler</code>. You can display an error by typing like:
<code>alarm_handler:set_alarm(tooHot)</code>.</p>

<p>In order to achieve this module, start the erlang shell with the
argument <code>-boot start_sasl</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~/programming/erlang <span class="nv">$ </span>erl -boot start_sasl
</span><span class='line'>Eshell V5.8.5  <span class="o">(</span>abort with ^G<span class="o">)</span>
</span><span class='line'>1&gt; alarm_handler:set_alarm<span class="o">(</span>tooHot<span class="o">)</span>.
</span><span class='line'><span class="nv">ok</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span>INFO <span class="nv">REPORT</span><span class="o">====</span> 5-Jan-2012::10:10:56 <span class="o">===</span>
</span><span class='line'>    alarm_handler: <span class="o">{</span><span class="nb">set</span>,tooHot<span class="o">}</span>
</span><span class='line'>2&gt; alarm_handler:clear_alarm<span class="o">(</span>tooHot<span class="o">)</span>.
</span><span class='line'><span class="nv">ok</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span>INFO <span class="nv">REPORT</span><span class="o">====</span> 5-Jan-2012::10:11:02 <span class="o">===</span>
</span><span class='line'>    alarm_handler: <span class="o">{</span>clear,tooHot<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sometimes you may want to define your own alarm handler, OTP
provides a interface to do so: <code>gen_event</code>. You can get a template of
this behaviour under emacs mode by clicking : Erlang -> skeleton ->
gen_event, which looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">my_alarm_handler</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_event</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">add_handler</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_event</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>   <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SERVER</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">state</span><span class="p">,</span> <span class="p">{}).</span>
</span><span class='line'><span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_event</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="no">?SERVER</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add_handler</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_event</span><span class="p">:</span><span class="n">add_handler</span><span class="p">(</span><span class="no">?SERVER</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">,</span> <span class="p">[]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{}}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_event</span><span class="p">(_</span><span class="nv">Event</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Request</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Reply</span> <span class="o">=</span> <span class="n">ok</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">ok</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may find that it almost looks like the <code>gen_server</code> behavior we
have seen before, with a new method <code>handle_event</code>, which accept a
message and a old state, then returns a new state.</p>

<figure class='code'><figcaption><span> (my_alarm_handler.erl)</span> <a href='/downloads/code/my_alarm_handler.erl'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">my_alarm_handler</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_event</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">add_handler</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_event</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>   <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SERVER</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_event</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="no">?SERVER</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add_handler</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_event</span><span class="p">:</span><span class="n">add_handler</span><span class="p">(</span><span class="no">?SERVER</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">,</span> <span class="p">[]).</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nf">init</span><span class="p">(</span><span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;*** my_alamr_handler init:</span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Args</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="mi">0</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_event</span><span class="p">({</span><span class="n">set_alarm</span><span class="p">,</span> <span class="n">tooHot</span><span class="p">},</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">error_logger</span><span class="p">:</span><span class="n">error_msg</span><span class="p">(</span><span class="s">&quot;*** Tell the Engineer to turn on the fan</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="o">+</span><span class="mi">1</span><span class="p">};</span>
</span><span class='line'><span class="nf">handle_event</span><span class="p">({</span><span class="n">clear_alarm</span><span class="p">,</span> <span class="n">tooHot</span><span class="p">},</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">error_logger</span><span class="p">:</span><span class="n">error_msg</span><span class="p">(</span><span class="s">&quot;*** Danger over. Turn off the fan</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">};</span>
</span><span class='line'><span class="nf">handle_event</span><span class="p">(</span><span class="nv">Event</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;*** unmatched event:</span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Event</span><span class="p">]),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Request</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Reply</span> <span class="o">=</span> <span class="nv">N</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">N</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">N</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">N</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">ok</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>What this code does is basically define an error handler that can
handle two types of alarm message, {set_alarm} and {clear_alarm}.</p>

<p>So now, how to use the handler? We can start the system, swap its
default error handler with our new handler. The bash code looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="err">~</span><span class="o">/</span><span class="n">programming</span><span class="o">/</span><span class="n">erlang</span> <span class="err">#</span> <span class="n">erl</span> <span class="o">-</span><span class="n">boot</span> <span class="n">start_sasl</span> <span class="o">-</span><span class="n">config</span> <span class="n">elog3</span>
</span><span class='line'><span class="nv">Eshell</span> <span class="nv">V5</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">5</span>  <span class="p">(</span><span class="n">abort</span> <span class="n">with</span> <span class="err">^</span><span class="nv">G</span><span class="p">)</span>
</span><span class='line'><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">gen_event</span><span class="p">:</span><span class="n">swap_handler</span><span class="p">(</span><span class="n">alarm_handler</span><span class="p">,</span> <span class="p">{</span><span class="n">alarm_handler</span><span class="p">,</span> <span class="n">swap</span><span class="p">},</span> <span class="p">{</span><span class="n">my_alarm_handler</span><span class="p">,</span> <span class="n">xyz</span><span class="p">}).</span>
</span><span class='line'><span class="o">***</span> <span class="n">my_alamr_handler</span> <span class="nn">init</span><span class="p">:{</span><span class="n">xyz</span><span class="p">,{</span><span class="n">alarm_handler</span><span class="p">,[]}}</span>
</span><span class='line'><span class="n">ok</span>
</span><span class='line'><span class="mi">2</span><span class="o">&gt;</span> <span class="nn">alarm_handler</span><span class="p">:</span><span class="n">set_alarm</span><span class="p">(</span><span class="n">tooHot</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">ERROR</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">14</span><span class="o">-</span><span class="nv">Jan</span><span class="o">-</span><span class="mi">2012</span><span class="p">::</span><span class="mi">22</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">44</span> <span class="o">===</span>
</span><span class='line'><span class="o">***</span> <span class="nv">Tell</span> <span class="n">the</span> <span class="nv">Engineer</span> <span class="n">to</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">the</span> <span class="n">fan</span>
</span><span class='line'><span class="n">ok</span>
</span><span class='line'><span class="mi">3</span><span class="o">&gt;</span> <span class="nn">alarm_handler</span><span class="p">:</span><span class="n">clear_alarm</span><span class="p">(</span><span class="n">tooHot</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">ERROR</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">14</span><span class="o">-</span><span class="nv">Jan</span><span class="o">-</span><span class="mi">2012</span><span class="p">::</span><span class="mi">22</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">05</span> <span class="o">===</span>
</span><span class='line'><span class="o">***</span> <span class="nv">Danger</span> <span class="n">over</span><span class="p">.</span> <span class="nv">Turn</span> <span class="n">off</span> <span class="n">the</span> <span class="n">fan</span>
</span><span class='line'><span class="n">ok</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/21/introduction-to-erlang-otp/">Introduction to Erlang OTP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-21T16:35:00-05:00" pubdate data-updated="true">Dec 21<span>st</span>, 2011</time>
        
         | <a href="/blog/2011/12/21/introduction-to-erlang-otp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>What&#8217;s OTP</h2>

<p><code>OTP</code> stands for Open Telecom Platform. Don&#8217;t be scared by its name,
basically it is just a software framework. It is similart to OO
language that you can implement your own code(In OO is called
sub-class, in Erlang or sequential language it is called call-back
functions), insert them into interfaces(which is called <code>behaviour</code> in
Erlang) provided by the framework and everything works.</p>

<p>OTP provides all the trivial parts of writing a server, like error
handling, concurrency issues, supervision tree and etc. Client
developers are only required to implement the functional parts(for
short, the &#8216;fun&#8217; parts).</p>

<h2>gen_server</h2>

<p><code>gen_server</code> is a module in Erlang that represents a generic
server. It is the framework that we are talking about Earlier. So
where is the interface that it provides in which we can plug our code?
Just open your emacs in
<a href="http://www.erlang.org/doc/apps/tools/erlang_mode_chapter.html">Erlang Mode</a>,
select Menu->Erlang->Skeletons->gen_server, you can get a list of
interface that you have to implement, which looks like this:</p>

<figure class='code'><figcaption><span> (template.erl)</span> <a href='/downloads/code/template.erl'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">gen_server_template</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>   <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SERVER</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">state</span><span class="p">,</span> <span class="p">{}).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="no">?SERVER</span><span class="p">},</span> <span class="no">?MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{}}.</span>
</span><span class='line'><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Request</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Reply</span> <span class="o">=</span> <span class="n">ok</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class='line'><span class="nf">handle_cast</span><span class="p">(_</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class='line'><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class='line'><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">ok</span><span class="p">.</span>
</span><span class='line'><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVsn</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first function, start_link/0, is used to start a local server
called ?SERVER with a callback module ?MODULE. other arguments can be
omitted now.</p>

<p>The new few six methods is what we are going to implement in the next step:</p>

<h2>Online Banking System </h2>

<p>A transaction system with withdraw and deposit would be a perfect
example for a gen_server. Our server has to implement a few callback
functions to support this behaviour. We will use
<a href="http://www.erlang.org/doc/man/ets.html">Erlang ETS</a> as a storage
engine. So, first, change the init/0 method so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">init</span><span class="p">([])</span>     <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">ets</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="p">[])}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>It simply create a new table with the table name equals to module
name. Also, it pass its second argument, which is the table we&#8217;ve
just created, as the initial state of the server.</p>

<p>We need to support remote call to this server, so we have to overide
the handle_call function so it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">handle_call</span><span class="p">({</span><span class="n">new</span><span class="p">,</span> <span class="nv">Who</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Reply</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">ets</span><span class="p">:</span><span class="n">lookup</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">Who</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">[]</span> <span class="o">-&gt;</span> <span class="nn">ets</span><span class="p">:</span><span class="n">insert</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="mi">0</span><span class="p">}),</span>
</span><span class='line'>            <span class="p">{</span><span class="n">welcome</span><span class="p">,</span> <span class="nv">Who</span><span class="p">};</span>
</span><span class='line'>      <span class="p">[_]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="n">you_already_are_a_customer</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">};</span>
</span><span class='line'><span class="nf">handle_call</span><span class="p">({</span><span class="n">add</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="nv">X</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Reply</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">ets</span><span class="p">:</span><span class="n">lookup</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">Who</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">not_a_customer</span><span class="p">;</span>
</span><span class='line'>      <span class="p">[{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Balance</span><span class="p">}]</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="nv">NewBalance</span> <span class="o">=</span> <span class="nv">Balance</span> <span class="o">+</span> <span class="nv">X</span><span class="p">,</span>
</span><span class='line'>          <span class="nn">ets</span><span class="p">:</span><span class="n">insert</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">}),</span>
</span><span class='line'>          <span class="p">{</span><span class="n">thanks</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="n">your_balance_is</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">};</span>
</span><span class='line'><span class="nf">handle_call</span><span class="p">({</span><span class="n">remove</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="nv">X</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Reply</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">ets</span><span class="p">:</span><span class="n">lookup</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="nv">Who</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">not_a_customer</span><span class="p">;</span>
</span><span class='line'>      <span class="p">[{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Balance</span><span class="p">}]</span> <span class="k">when</span> <span class="nv">X</span> <span class="o">=&lt;</span> <span class="nv">Balance</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="nv">NewBalance</span> <span class="o">=</span> <span class="nv">Balance</span> <span class="o">-</span> <span class="nv">X</span><span class="p">,</span>
</span><span class='line'>          <span class="nn">ets</span><span class="p">:</span><span class="n">insert</span><span class="p">(</span><span class="nv">Tab</span><span class="p">,</span> <span class="p">{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">}),</span>
</span><span class='line'>          <span class="p">{</span><span class="n">thanks</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="n">your_balance_is</span><span class="p">,</span> <span class="nv">NewBalance</span><span class="p">};</span>
</span><span class='line'>      <span class="p">[{</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Balance</span><span class="p">}]</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="p">{</span><span class="n">sorry</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="n">you_only_have</span><span class="p">,</span> <span class="nv">Balance</span><span class="p">,</span> <span class="n">in_the_bank</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Reply</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">};</span>
</span><span class='line'><span class="nf">handle_call</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="nv">Tab</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this code, argument Tab maintains the <code>state</code> of the server, the
initial state is defined by init function, which we&#8217;ve talked about
ealier.</p>

<p>So, that&#8217;s it. The code is quite straightforward. A point worth noting
here is that Handle_call here is just like a controller in MVC
architecture. Which redirect the request to different logic.</p>

<p>How to call this server? It is simple with gen_server:call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">new</span><span class="p">,</span> <span class="nv">Who</span><span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>?MODULE</code> here stands for the server name, which we&#8217;ve specified
at the start_link process. Now let&#8217;s write another wrapper for the
server so the user can use it with out interact with gen_server
module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">},</span> <span class="no">?MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
</span><span class='line'><span class="nf">stop</span><span class="p">()</span>  <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="n">stop</span><span class="p">).</span>
</span><span class='line'>  
</span><span class='line'><span class="nf">new_account</span><span class="p">(</span><span class="nv">Who</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">new</span><span class="p">,</span> <span class="nv">Who</span><span class="p">}).</span>
</span><span class='line'><span class="nf">deposit</span><span class="p">(</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">add</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">}).</span>
</span><span class='line'><span class="nf">withdraw</span><span class="p">(</span><span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?MODULE</span><span class="p">,</span> <span class="p">{</span><span class="n">remove</span><span class="p">,</span> <span class="nv">Who</span><span class="p">,</span> <span class="nv">Amount</span><span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure>


<p>Start our shell(presee C-c C-z in Emacs) and test it, here is our example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="mi">1</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">start</span><span class="p">().</span>
</span><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">34</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">}</span>
</span><span class='line'><span class="mi">2</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">new_account</span><span class="p">(</span><span class="s">&quot;Joe&quot;</span><span class="p">).</span>
</span><span class='line'><span class="p">{</span><span class="n">welcome</span><span class="p">,</span><span class="s">&quot;Joe&quot;</span><span class="p">}</span>
</span><span class='line'><span class="mi">3</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">deposit</span><span class="p">(</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">).</span>
</span><span class='line'><span class="p">{</span><span class="n">thanks</span><span class="p">,</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span><span class="n">your_balance_is</span><span class="p">,</span><span class="mi">100</span><span class="p">}</span>
</span><span class='line'><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">deposit</span><span class="p">(</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span>
</span><span class='line'><span class="p">{</span><span class="n">thanks</span><span class="p">,</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span><span class="n">your_balance_is</span><span class="p">,</span><span class="mi">110</span><span class="p">}</span>
</span><span class='line'><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">deposit</span><span class="p">(</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">).</span>
</span><span class='line'><span class="p">{</span><span class="n">thanks</span><span class="p">,</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span><span class="n">your_balance_is</span><span class="p">,</span><span class="mi">210</span><span class="p">}</span>
</span><span class='line'><span class="mi">6</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">withdraw</span><span class="p">(</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">).</span>
</span><span class='line'><span class="p">{</span><span class="n">thanks</span><span class="p">,</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span><span class="n">your_balance_is</span><span class="p">,</span><span class="mi">110</span><span class="p">}</span>
</span><span class='line'><span class="mi">7</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">withdraw</span><span class="p">(</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">).</span>
</span><span class='line'><span class="p">{</span><span class="n">sorry</span><span class="p">,</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span><span class="n">you_only_have</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="n">in_the_bank</span><span class="p">}</span>
</span><span class='line'><span class="mi">8</span><span class="o">&gt;</span> <span class="nn">my_bank</span><span class="p">:</span><span class="n">stop</span><span class="p">().</span>
</span><span class='line'><span class="n">stopped</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/20/introduction-to-erlang/">Introduction to Erlang</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-20T23:08:00-05:00" pubdate data-updated="true">Dec 20<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/12/20/introduction-to-erlang/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The term <a href="http://www.erlang.org/">Erlang</a> comes from &#8216;Erission
Language&#8217;. It is designed for telecommunication industry with
concurrency in mind.</p>

<p>The most famous application of Erlang would probably be Facebook chat
and Tencent QQ. Both are IM services that can support millions of
users sending messages at the same time.</p>

<p>Let&#8217;s start with a simple application so that you can have a basic
understanding of how beautiful Erlang is.</p>

<p>Suppose we have to implement a message passing ring of N nodes(A node
is a process), a message will be passing through the ring for M
times. Besides, we need to profile the program, see how much time it
needs to be finished.</p>

<p>Before you read the code written in Erlang, first think about how you
can implement this in C or C++ code.</p>

<p>Here we go, ready for some beautiful code?</p>

<figure class='code'><figcaption><span> (ring.erl)</span> <a href='/downloads/code/ring.erl'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">ring</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">(</span><span class="nv">Y</span><span class="p">)</span> <span class="k">end</span><span class="p">);</span>
</span><span class='line'><span class="nf">gen</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">Y</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">gen</span><span class="p">(</span><span class="nv">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">loop</span><span class="p">(</span><span class="nv">Y</span><span class="p">)</span> <span class="k">end</span><span class="p">)).</span>
</span><span class='line'><span class="nf">gen</span><span class="p">(</span><span class="nv">N</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">gen</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span> <span class="n">loop</span><span class="o">/</span><span class="mi">0</span><span class="p">)).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">start</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">M</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Pid</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="nv">N</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;start time:</span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nn">erlang</span><span class="p">:</span><span class="n">now</span><span class="p">()]),</span>
</span><span class='line'>    <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Pid</span><span class="p">,</span> <span class="nv">M</span><span class="p">,</span> <span class="n">self</span><span class="p">()},</span>
</span><span class='line'>    <span class="k">receive</span>
</span><span class='line'>  <span class="n">finished</span><span class="o">-&gt;</span>
</span><span class='line'>      <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;end time:</span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nn">erlang</span><span class="p">:</span><span class="n">now</span><span class="p">()])</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">receive</span>
</span><span class='line'>  <span class="p">{_</span><span class="nv">Next</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">Dist</span><span class="p">}</span><span class="o">-&gt;</span>
</span><span class='line'>      <span class="nv">Dist</span><span class="o">!</span><span class="n">finished</span><span class="p">;</span>
</span><span class='line'>  <span class="p">{</span><span class="nv">Next</span><span class="p">,</span> <span class="nv">M</span><span class="p">,</span> <span class="nv">Dist</span><span class="p">}</span><span class="o">-&gt;</span>
</span><span class='line'>      <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;loop </span><span class="si">~p</span><span class="s"> finished</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">M</span><span class="p">]),</span>
</span><span class='line'>      <span class="nv">Next</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Next</span><span class="p">,</span> <span class="nv">M</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">Dist</span><span class="p">},</span>
</span><span class='line'>      <span class="n">loop</span><span class="p">()</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">loop</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">receive</span>    
</span><span class='line'>  <span class="p">{</span><span class="nv">Src</span><span class="p">,</span> <span class="nv">M</span><span class="p">,</span> <span class="nv">Dist</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nv">X</span> <span class="o">!</span> <span class="p">{</span><span class="nv">Src</span><span class="p">,</span> <span class="nv">M</span><span class="p">,</span> <span class="nv">Dist</span><span class="p">},</span>
</span><span class='line'>      <span class="n">loop</span><span class="p">(</span><span class="nv">X</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>Now that we&#8217;ve seen some code in Erlang. if you seen it is cool, you
can go on with me and learn some basic concepts of it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/11/map-join-in-hive/">A Better Map Join in Hive</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-11T01:47:00-05:00" pubdate data-updated="true">Dec 11<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/12/11/map-join-in-hive/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Although <a href="hadoop.apache.org" title="Hadoop">Hadoop</a> provides a general way to handle distributed data, it is hard to write map reduce program every time you want to handle some data. At this time, <a href="hive.apache.org">Hive</a> comes into play to save people from the hell of writing map reduce programs.</p>

<p><img src="http://hadoop.apache.org/images/hadoop-logo.jpg" alt="Hadoop" /> <img src="http://hive.apache.org/images/hive_logo_medium.jpg" alt="Hive" /></p>

<p>Hive is a data warehouse built on top of Hadoop. It provides a SQL-like interface so that SQL programmer can easily pick it up. Data warehouse means the operation for this database should be read-optimized. Instead of thousands of transactions at a time, there are not so many request to Hive, and most of these request should be query and bulk loading.</p>

<p>Join is an important part in query. How to proceed join fast is extremely important in this read-optimization scenario. An fairly straight forward way, which is called <strong>Common Join</strong>, to join in map-reduce environment is divided into 3 phases:</p>

<ul>
<li> <strong>map phase</strong> which split and read the whole table and emit key(join key) value(select value) pairs</li>
<li> <strong>shuffle phase</strong> which merges and sorts these pairs by key</li>
<li> <strong>reduce phase</strong> which does the actual join work by combining all the pairs with the same key together</li>
</ul>


<p>Amoung these three phases, shuffle phase is most time consuming. If a table is small enough to fit into mapper&#8217;s memory after it is converted into <em>hashtable</em>(with the same key value pair as mentioned above), then <strong>Map Join</strong> is introduced, which builds a hashtable file for the small table, copy the file to each mapper so that each mapper can probe a split of the bigtable and get the join result. By doing this way, the system can avoid shuffle and reduce phase, result in significant speed-up.</p>

<p>Some points have to be clear</p>

<ol>
<li>A table in Hive is actually a file in file system.</li>
<li>In map join, this relational table on disk is converted to a hashtable in memory.</li>
<li>A small table file on disk could be too large to fit into memory
for two reasons, the first one is it may be compressed, the other is
that the key density could be high(a low key density means most keys
are same in the relational table, after it turns into hashtable, all
the pairs with the same key can be stored using just one key.).</li>
</ol>


<p>So here comes the question, how can we know if a table can fit into memory after it is converted into hashtable? Current solution of Hive is somewhat conservative, it just read the size of the table file. If it is larger than 25MB, Hive thinks it would be too large and do common join. If it is smaller than 25MB, Hive will do map join instead because it thinks this table can fit into memory.</p>

<p>The above solution is somehow unreasonable because as we mentioned before, table file size has no so strong connect to hashtable size.</p>

<p>Our course project in <a href="http://www.eecs.umich.edu/~michjc/eecs584/index.html">EECS 584, Advanced Database System</a> aims at proposing a better selecting criteria for map join and common join.</p>

<p>Instead of trying to infer hashtable size at runtime, our solution, in short, tries to get the exactly hashtable size when loading data into the table. That is, we build a hash table beforehand, when we loads data into the table. To reduce the amount of hashtables (Cound be 2<sup>N</sup> tables if we want to cover all the fields as potential join keys), we propose a way similar as building an index(we select interesting fields and maintain an index, instead of building indexes for every column combinations). A new keyword is proposed for this purpose, &#8221;<strong>PRECOMPUTE</strong>&#8221;. The usage of this keyword goes like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">People</span><span class="p">(</span><span class="n">id</span> <span class="n">STRING</span><span class="p">,</span> <span class="n">name</span> <span class="n">String</span><span class="p">,</span> <span class="n">age</span> <span class="nb">INT</span><span class="p">)</span> <span class="n">PRECOMPUTE</span> <span class="n">id</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will build a hashtable in advance in the memory. Note that <strong>once the hashtable exceeds the memory limits, the building process will automatically break and label this field as &#8216;bad for hash&#8217;.</strong></p>

<p>Another advantage of this is that, consider the following query, :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">Select</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">People</span> <span class="n">p</span> <span class="k">Where</span> <span class="n">p</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="s1">&#39;0000001&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The query will build a hashtable for small table whose size equals 1 (because of the single selection predicate). This will definitely fits in the memory. However, in previous implementation, if the file size exceeds 25MBs (or whatever defined by user), Hive will use Common Join to execute it, although it can use mapjoin instead (because the hashtable can fit in the memory) and achieve better performance!</p>

<hr />

<p>In our implementation, since we&#8217;ve build a hashtable beforehand, we now how many different keys the table contains (denoted as ICARD) and the total memory consumption of this hashtable (denoted as S). We can then get the selection factor sf by following equation:</p>

<p>sf = 1 / ICARD</p>

<p>And we the the memory consumtion of this query&#8217;s hashtable is:</p>

<p>S&#8217; = S * sf</p>

<p>also we can get other predict equations of other kind of predicats.</p>

<p>If a hashtable with physical size S&#8217; can fit in mapper&#8217;s memory, we use Map Join, otherwise, Common Join. This further increased the probabilities of using Map Join.</p>

<p>As a conclusion, current implementation of Hive losses many opportunities of using Map Join. We improved the chance a little bit by precomputing hash table in advance, and leverage the heuristic information when we execute a query.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/01/05/erlang-otp-error-handler/">Erlang OTP &#8211; Error Handler</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/21/introduction-to-erlang-otp/">Introduction to Erlang OTP</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/20/introduction-to-erlang/">Introduction to Erlang</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/12/11/map-join-in-hive/">A Better Map join in Hive</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Yunxing dai -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'imbalism';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
